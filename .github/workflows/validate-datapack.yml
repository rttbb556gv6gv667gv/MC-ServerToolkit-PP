name: Validate Datapack

on:
  pull_request:
    paths:
      - 'new_versions/**/datapack/**'
      - '.github/workflows/validate-datapack.yml'
  push:
    branches:
      - main
    paths:
      - 'new_versions/**/datapack/**'
      - '.github/workflows/validate-datapack.yml'
  workflow_dispatch:

env:
  STRICT_MODE: false  # true = unknown commands fail, false = warnings only
  TARGET: release     # release | snapshot

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq tree
          echo "‚úÖ Dependencies installed"

      # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      # COMBINED VALIDATION - All checks in one step for better UI
      # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      - name: Validate Datapack (All Checks)
        run: |
          set -e  # Exit on first error
          
          TOTAL_ERRORS=0
          TOTAL_WARNINGS=0
          
          # Valid pack formats
          VALID_FORMATS=(81 88 94)
          INVALID_THRESHOLD=80
          
          # Create cache directory
          mkdir -p /tmp/pack_formats
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üöÄ DATAPACK VALIDATION STARTED"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # 1. JSON SYNTAX VALIDATION
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîç [1/5] Validating JSON Files..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          json_error=0
          json_count=0
          failed_files=()
          
          while IFS= read -r -d $'\0' file; do
            json_count=$((json_count + 1))
            if ! jq empty "$file" 2>/dev/null; then
              echo "  ‚ùå Invalid JSON: $file"
              failed_files+=("$file")
              json_error=1
            fi
          done < <(find new_versions -name "*.json" -type f -print0)
          
          if [ $json_error -eq 0 ]; then
            echo "  ‚úÖ All $json_count JSON files are valid"
          else
            echo "  ‚ùå Failed: ${#failed_files[@]} file(s)"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          echo ""
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # 2. PACK.MCMETA VALIDATION
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ [2/5] Validating pack.mcmeta..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          mcmeta_error=0
          mcmeta_warnings=0
          mcmeta_count=0
          
          while IFS= read -r -d $'\0' file; do
            mcmeta_count=$((mcmeta_count + 1))
            datapack_root=$(dirname "$file")
            datapack_id=$(echo "$datapack_root" | md5sum | cut -d' ' -f1)
            
            echo "  üì¶ $file"
            
            if ! jq -e '.pack.pack_format' "$file" > /dev/null 2>&1; then
              echo "     ‚ùå Missing pack.pack_format"
              mcmeta_error=1
              continue
            fi
            
            pack_format=$(jq -r '.pack.pack_format' "$file")
            echo "$pack_format:$datapack_root" > "/tmp/pack_formats/${datapack_id}.txt"
            
            is_valid=0
            for valid_format in "${VALID_FORMATS[@]}"; do
              if [ "$pack_format" -eq "$valid_format" ] 2>/dev/null; then
                is_valid=1
                break
              fi
            done
            
            if [ $is_valid -eq 1 ]; then
              echo "     ‚úÖ Pack format: $pack_format"
            elif [ "$pack_format" -le "$INVALID_THRESHOLD" ] 2>/dev/null; then
              echo "     ‚ùå Invalid pack_format $pack_format (must be 81, 88, or 94)"
              mcmeta_error=1
            else
              echo "     ‚ö†Ô∏è  Unknown pack_format: $pack_format"
              mcmeta_warnings=$((mcmeta_warnings + 1))
            fi
            
            # Check for non-standard fields
            if jq -e '.pack.min_format' "$file" > /dev/null 2>&1; then
              echo "     ‚ö†Ô∏è  Non-standard field: pack.min_format"
              mcmeta_warnings=$((mcmeta_warnings + 1))
            fi
            if jq -e '.pack.max_format' "$file" > /dev/null 2>&1; then
              echo "     ‚ö†Ô∏è  Non-standard field: pack.max_format"
              mcmeta_warnings=$((mcmeta_warnings + 1))
            fi
            if jq -e '.metadata' "$file" > /dev/null 2>&1; then
              echo "     ‚ö†Ô∏è  Non-standard field: metadata"
              mcmeta_warnings=$((mcmeta_warnings + 1))
            fi
            
          done < <(find new_versions -path "*/datapack/pack.mcmeta" -type f -print0)
          
          if [ $mcmeta_count -eq 0 ]; then
            echo "  ‚ùå No pack.mcmeta files found"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          elif [ $mcmeta_error -eq 0 ]; then
            echo "  ‚úÖ All pack.mcmeta files valid"
            [ $mcmeta_warnings -gt 0 ] && echo "  ‚ö†Ô∏è  $mcmeta_warnings warning(s)"
          else
            echo "  ‚ùå pack.mcmeta validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          TOTAL_WARNINGS=$((TOTAL_WARNINGS + mcmeta_warnings))
          echo ""
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # 3. DATAPACK STRUCTURE
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìÅ [3/5] Validating Structure..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          struct_error=0
          datapack_count=0
          
          while IFS= read -r -d $'\0' file; do
            dir=$(dirname "$file")
            datapack_count=$((datapack_count + 1))
            
            if [ ! -d "$dir/data" ]; then
              echo "  ‚ùå Missing data/ in: $dir"
              struct_error=1
            else
              namespace_count=$(find "$dir/data" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
              echo "  ‚úÖ Datapack: $dir ($namespace_count namespace(s))"
            fi
          done < <(find new_versions -path "*/datapack/pack.mcmeta" -type f -print0)
          
          if [ $struct_error -eq 0 ]; then
            echo "  ‚úÖ Structure validation passed"
          else
            echo "  ‚ùå Structure validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          echo ""
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # 4. FUNCTION FILES VALIDATION
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚öôÔ∏è  [4/5] Validating Functions..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          func_error=0
          func_warnings=0
          total_funcs=0
          total_commands=0
          
          # Command compatibility matrix
          declare -A command_min_format
          command_min_format["say"]=1
          command_min_format["tellraw"]=1
          command_min_format["execute"]=1
          command_min_format["scoreboard"]=1
          command_min_format["function"]=1
          command_min_format["item"]=81
          command_min_format["damage"]=81
          command_min_format["ride"]=81
          command_min_format["return"]=81
          command_min_format["tick"]=81
          command_min_format["random"]=81
          
          declare -A deprecated_commands
          deprecated_commands["replaceitem"]="Use /item replace (requires pack_format 81+)"
          
          while IFS= read -r -d $'\0' file; do
            total_funcs=$((total_funcs + 1))
            
            # Find pack format
            current_pack_format=0
            file_dir="$file"
            while [ "$file_dir" != "/" ] && [ "$file_dir" != "." ]; do
              if [ -f "$file_dir/pack.mcmeta" ]; then
                datapack_id=$(echo "$file_dir" | md5sum | cut -d' ' -f1)
                if [ -f "/tmp/pack_formats/${datapack_id}.txt" ]; then
                  current_pack_format=$(cut -d':' -f1 "/tmp/pack_formats/${datapack_id}.txt")
                fi
                break
              fi
              file_dir=$(dirname "$file_dir")
            done
            
            relative_path=$(echo "$file" | sed "s|^$(pwd)/||")
            file_cmd_count=0
            line_num=0
            
            while IFS= read -r line; do
              line_num=$((line_num + 1))
              [[ "$line" =~ ^[[:space:]]*$ ]] && continue
              [[ "$line" =~ ^[[:space:]]*# ]] && continue
              
              file_cmd_count=$((file_cmd_count + 1))
              total_commands=$((total_commands + 1))
              
              clean_line=$(echo "$line" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              [[ "$clean_line" =~ ^/ ]] && clean_line="${clean_line:1}"
              cmd=$(echo "$clean_line" | awk '{print $1}')
              
              # Check deprecated
              if [ -n "${deprecated_commands[$cmd]}" ]; then
                echo "  ‚ùå $relative_path:$line_num - Deprecated: /$cmd"
                func_error=1
                continue
              fi
              
              # Check compatibility
              if [ -n "${command_min_format[$cmd]}" ]; then
                required_format="${command_min_format[$cmd]}"
                if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt "$required_format" ]; then
                  echo "  ‚ùå $relative_path:$line_num - /$cmd requires pack_format $required_format+"
                  func_error=1
                fi
              fi
              
              # Execute subcommand checks
              if [[ "$clean_line" =~ ^execute ]]; then
                if [[ "$clean_line" =~ (if|unless)[[:space:]]+biome ]] && [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt 81 ]; then
                  echo "  ‚ùå $relative_path:$line_num - 'execute if/unless biome' requires pack_format 81+"
                  func_error=1
                fi
              fi
              
            done < "$file"
            
            [ $file_cmd_count -gt 0 ] && echo "  ‚úì $relative_path ($file_cmd_count commands)"
            
          done < <(find new_versions -path "*/datapack/data/*/function/*.mcfunction" -type f -print0)
          
          echo "  üìä Total: $total_funcs files, $total_commands commands"
          
          if [ $func_error -eq 0 ]; then
            echo "  ‚úÖ Function validation passed"
            [ $func_warnings -gt 0 ] && echo "  ‚ö†Ô∏è  $func_warnings warning(s)"
          else
            echo "  ‚ùå Function validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          TOTAL_WARNINGS=$((TOTAL_WARNINGS + func_warnings))
          echo ""
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # 5. MACRO VALIDATION
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîß [5/5] Validating Macros..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          macro_error=0
          files_with_macros=0
          total_macro_vars=0
          
          while IFS= read -r -d $'\0' file; do
            current_pack_format=0
            file_dir="$file"
            while [ "$file_dir" != "/" ] && [ "$file_dir" != "." ]; do
              if [ -f "$file_dir/pack.mcmeta" ]; then
                datapack_id=$(echo "$file_dir" | md5sum | cut -d' ' -f1)
                if [ -f "/tmp/pack_formats/${datapack_id}.txt" ]; then
                  current_pack_format=$(cut -d':' -f1 "/tmp/pack_formats/${datapack_id}.txt")
                fi
                break
              fi
              file_dir=$(dirname "$file_dir")
            done
            
            relative_path=$(echo "$file" | sed "s|^$(pwd)/||")
            macro_vars=$(grep -oP '\$\(\K[a-zA-Z0-9_]+(?=\))' "$file" 2>/dev/null | sort -u)
            macro_count=$(echo "$macro_vars" | grep -c '.' 2>/dev/null || echo 0)
            
            if [ $macro_count -gt 0 ]; then
              files_with_macros=$((files_with_macros + 1))
              total_macro_vars=$((total_macro_vars + macro_count))
              
              echo "  üîß $relative_path ($macro_count macro variable(s))"
              
              if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt 81 ]; then
                echo "     ‚ùå Macros require pack_format 81+ (current: $current_pack_format)"
                macro_error=1
              fi
            fi
          done < <(find new_versions -path "*/datapack/data/*/function/*.mcfunction" -type f -print0)
          
          if [ $macro_error -eq 0 ]; then
            if [ $files_with_macros -eq 0 ]; then
              echo "  ‚ÑπÔ∏è  No macros detected"
            else
              echo "  ‚úÖ Macro validation passed ($files_with_macros files)"
            fi
          else
            echo "  ‚ùå Macro validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          echo ""
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # FINAL SUMMARY
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìã VALIDATION SUMMARY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "  üì¶ Datapacks:  $datapack_count"
          echo "  üìÑ JSON files: $json_count"
          echo "  ‚öôÔ∏è  Functions:  $total_funcs"
          echo "  üí¨ Commands:   $total_commands"
          echo "  üîß With macros: $files_with_macros"
          echo ""
          
          if [ $TOTAL_ERRORS -eq 0 ]; then
            echo "  ‚úÖ ALL VALIDATIONS PASSED"
            [ $TOTAL_WARNINGS -gt 0 ] && echo "  ‚ö†Ô∏è  $TOTAL_WARNINGS warning(s) detected"
            echo ""
            echo "  üöÄ Datapack is production-ready!"
          else
            echo "  ‚ùå VALIDATION FAILED"
            echo "  ‚ùå Errors: $TOTAL_ERRORS"
            echo "  ‚ö†Ô∏è  Warnings: $TOTAL_WARNINGS"
            echo ""
            echo "  Common issues:"
            echo "    ‚Ä¢ pack_format must be 81, 88, or 94"
            echo "    ‚Ä¢ Commands must match pack_format requirements"
            echo "    ‚Ä¢ Macros require pack_format 81+"
          fi
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Exit with error if any validation failed
          [ $TOTAL_ERRORS -gt 0 ] && exit 1
          exit 0

      - name: Upload Validation Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-logs
          path: |
            new_versions/**/datapack/**/*.json
            new_versions/**/datapack/**/*.mcfunction
          retention-days: 7
